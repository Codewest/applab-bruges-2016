var menuOpen = false;

var addEventListeners = function () {
    $(".hamburger").on('click', toggleMenu);
    $(".menu-item").on('click', togglePage);
};

var toggleMenu = function() {
    toggleButtonIcon($(".hamburger i"), "menu", "close");
    $(".menu").slideToggle();
};

var togglePage = function() {
    $();
};

var toggleButtonIcon = function(button, openIcon, closeIcon) {
    if (menuOpen) {
        button.html(openIcon);
        menuOpen = false;
    } else {
        button.html(closeIcon);
        menuOpen = true;
    }
};

var xStart;
var yStart;

var determinePosition = function determinePosition() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(setPosition, showError);
    } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
};

function setPosition(position) {
    xStart = position.coords.latitude;
    yStart = position.coords.longitude;
}

function showError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            x.innerHTML = "User denied the request for Geolocation.";
            break;
        case error.POSITION_UNAVAILABLE:
            x.innerHTML = "Location information is unavailable.";
            break;
        case error.TIMEOUT:
            x.innerHTML = "The request to get user location timed out.";
            break;
        case error.UNKNOWN_ERROR:
            x.innerHTML = "An unknown error occurred.";
            break;
    }
}

var openRoute = function openRoute() {
    var xDestination = 51.2079017; //end x-position here (open data)
    var yDestination = 3.2221577; //end x-position here
    var xCenter = (xStart + xDestination)/2;
    var yCenter = (yStart + yDestination)/2;
    var zoom = 18.75;
    window.open("https://www.google.be/maps/dir/" + xStart + "," + yStart + "/" + xDestination + "," + yDestination + "/@" + xCenter + "," + yCenter + "," + zoom +"z");
};

var sendMarkers = function(geojson, map) {
  geojson.features.forEach(function(marker) {
    // create a DOM element for the marker
    var el = document.createElement('div');
    el.className = 'marker';
    el.style.backgroundImage = 'url(https://placekitten.com/g/' + marker.properties.iconSize.join('/') + '/)';
    el.style.width = marker.properties.iconSize[0] + 'px';
    el.style.height = marker.properties.iconSize[1] + 'px';

    el.addEventListener('click', function() {
        window.alert(marker.properties.message);
    });

    // add marker to map
    new mapboxgl.Marker(el, {offset: [-marker.properties.iconSize[0] / 2, -marker.properties.iconSize[1] / 2]})
        .setLngLat(marker.geometry.coordinates)
        .addTo(map);
  });
};



function setMarkers(map, coords) {
  var features = [];
  for (var i = 0; i < coords.length; i++) {
    var points = coords[i];
    var feature = {
        "type": "Feature",
        "properties": {
            "message": "A point",
            "iconSize": [60, 60]
        },
        "geometry": {
            "type": "A point",
            "coordinates": [points.long, points.lat]
        }
    };
    features.push(feature);
  }

  var geojson = {
    "type": "FeatureCollection",
    "features": features
  };

  sendMarkers(geojson, map);
}

var getCoordinatenGeneric = function getCoordinaten(url){
    var list = [];
    $.when($.getJSON(url).done(function (json) {
        for (var i = 0; i < json.length; i++) {
          var item = json[i];
          var geo = item.json_geometry;
          var coords = {
            lat: geo.coordinates[1],
            long: geo.coordinates[0]
          };
          list.push(coords);
        }
    }));
    return list;
};

function getCoordinatenMusea(){
    var list = [];
    $.when($.getJSON("data/musea.json").done(function (json) {
    for (var i = 0; i < json.length; i++) {
     var item = json[i];
     var address = item.Ligging.split(" ");
     $.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+address[0]+"+"+address[1]+"&key=AIzaSyAM6FLYxpA8usOS4sBeYwo3wwzifUMPEfE").done(function(json){
         var geo = json.results[0].geometry.location;
         var object;
         object = {
                    lat:geo.lat,
                   long:geo.lng

         };
        list.push(object);
     });

     }
 }));
     return list;
}

function getCoordinatenZitBanken(){
    var list = [];
    $.when($.getJSON("data/zitbanken.json").done(function (json) {
    for (var i = 0; i < json.length; i++) {
     var item = json[i];
     var geo = item.json_geometry;
     if(!Array.isArray(geo.coordinates[0])){
         var object;
         object = {
                    lat:geo.coordinates[1],
                   long:geo.coordinates[0]

         };
        list.push(object);
     }
     else{
         for(var j = 0; j<geo.coordinates.length;j++){
             var object;
             object = {
                 lat:geo.coordinates[j][1],
                 long:geo.coordinates[j][0]

             };
             list.push(object);
}}}
 }));
     return list;
}

var getCoordinatenParken = function getCoordinatenParken(){
    var list = [];
    $.when($.getJSON("data/groen.json").done(function (json) {
    for (var i = 0; i < json.length; i++) {
     var item = json[i];
     //console.log(item.BEHEERSOBJECT);
     if(item.BEHEERSOBJECT == "parken"){
         if(item.PUBLIEK_TOEGANKELIJK == "J"){
             console.log(item);
                var geo = item.json_geometry;
                var glat = 0;
                var glong = 0;
             for(var j=0; j<geo.coordinates.length; j++){
                 glat += geo.coordinates[0][j][1];
                 glong += geo.coordinates[0][j][0];
             }
             glat = glat/geo.coordinates.length;
             glong = glong/geo.coordinates.length;
             var object = {
                        lat:glat,
                       long:glong
             };
             list.push(object);
         }
    }
     }
 }));
    return list;
};

function getCoordinatenBib(){
    return getCoordinatenGeneric("/data/bibliotheken.json");
}

function getCoordinatenLokalen(){
    return getCoordinatenGeneric("/data/jeugdlokalen.json");
 }

 function getCoordinatenSport(){
     return getCoordinatenGeneric("/data/sport.json");
 }
 function getCoordinatenZwembaden(){
     return getCoordinatenGeneric("/data/zwembaden.json");
 }

var data = {
  libPoints: getCoordinatenBib,
  museumPoints: getCoordinatenMusea,
  sportPoints: getCoordinatenSport,
  swimmingPoints: getCoordinatenZwembaden,
  youthPoints: getCoordinatenLokalen,
  museaPoints: getCoordinatenMusea,
  benchPoints: getCoordinatenZitBanken,
  parkPoints: getCoordinatenParken
};

(function() {
    var map;
    var list = [];

    $(function () {
        makeMap();
        addEventListeners();
        $("#route").on('click', openRoute);
        setInterval(determinePosition, 5000);
        var points = data.benchPoints();
        setMarkers(map, points);
    });

    var makeMap = function makeMap() {
        mapboxgl.accessToken = 'pk.eyJ1Ijoicm9vdHNhbSIsImEiOiJjaXU5a2V4aGcwMDFlMnRtazRibjZiZGN3In0.Q1K1wv1ugX49a4e1pCLMZw';
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v9',
            center: [3.227180, 51.210358],
            zoom: 13.7
        });
    };
})();
